# 项目说明

---

## 📁 项目文件结构详解

### 🎯 主入口文件

| 文件 | 作用 | 主要功能 |
|---|---|---|
| `main_TG.m` | 主程序入口，控制整体流程 | 初始化路径和参数；调用地理计算/球面采样/目标参数设置；主循环生成不同姿态（360-8100）仿真图像；四元数旋转目标并遍历6个观测时刻；计算LOS与相机参数；生成并保存图像与关键点标注 |

### 📂 `subfunctions/` - 核心子函数目录

| 文件 | 作用 | 主要功能 |
|---|---|---|
| `GeoCal.m` | 地理坐标计算 | 加载轨道数据（`TLE/RAE.mat`）；设置观测站位置（纬度35.9°，经度116.4°）；目标轨道转ECEF；可视化轨道与观测站位置 |
| `param_target.m` | 目标模型参数设置 | 加载ISAR模型（`.mat`）与光学模型（`.obj`）；设置分辨率（ISAR 0.08m、光学0.3m）；定义6个关键点；模型坐标变换与缩放 |
| `sphere_homeo.m` | 球面采样初始化 | 调用 `sphere_homeo_sfc_isotropic_splg.m` 进行各向同性球面采样 |
| `sphere_homeo_sfc_isotropic_splg.m` | 球面同胚表面各向同性采样 | 球坐标参数化采样；生成采样点网格与三角剖分；支持均匀/随机采样 |
| `LOSCalculation_motion.m` | 视线方向计算（运动目标） | 基于ECEF计算目标与观测站LOS；动态扩展时间窗口保证有效转角≥阈值；LOS投影到目标本体坐标系（RVN）；计算垂直轴与水平轴 |
| `LOSCalculation.m` | 视线方向计算（静态版本） | 与 `LOSCalculation_motion.m` 类似，用于ISAR成像 |
| `Rot2angle.m` | 角度旋转矩阵计算 | 根据方位角与俯仰角生成旋转矩阵 |
| `isar_save.m` | ISAR图像保存（已注释，未使用） | 保存ISAR图像与关键点标注 |
| `linean.m` | 线性对齐/相位补偿 | 用于ISAR的距离对齐与相位补偿 |

### 📂 `subfunc_imagesimu/` - 图像仿真子函数目录

| 文件 | 作用 | 主要功能 |
|---|---|---|
| `image_generate.m` | 光学图像生成核心函数 | 调用 `buildtree2`（MEX）射线-三角面片求交；一次/二次散射能量（Lambert）；后处理（噪声、相位、FFT、加窗） |
| `CameraandRay.m` | 相机参数计算 | 为128×128像素计算相机位置与视线方向；按像素间距生成相机网格 |
| `rot.m` | 绕任意轴旋转矩阵 | 根据轴向量与角度生成3×3旋转矩阵 |
| `cal_insec.m` | 射线-三角面片求交（MATLAB版） | Möller-Trumbore求交；返回最短路径时间 |
| `cal_insec.cpp / cal_insec.mexw64` | 射线求交C++实现与编译版本 | 加速求交计算 |
| `buildtree2.mexw64` | 射线求交编译加速库 | 使用空间结构（如KD-tree/BVH）加速批量射线求交 |
| `GeoCalculation.m` | SAR几何计算 | 基于目标轨道建立SAR坐标系；计算速度方向与坐标系轴 |
| `ECEF_cal_SatTar.m` | 基于TLE计算卫星ECEF坐标 | SGP4轨道传播；转ECEF并计算可见弧段；生成RAE数据并保存 |
| `OTV_SARImagery_Simu.m` | SAR图像仿真（未在主流程使用） | 类似光学仿真，但用于SAR成像 |
| `Simu_Main_gai.m` | SAR仿真主函数（未在主流程使用） | 包含完整SAR仿真流程 |
| `Predata_Dispaly.m` | OBJ转MAT预处理器 | 读取OBJ；转换为三角面片矩阵并保存为`.mat` |
| `SAR_Geometry_Cal.m` | SAR几何参数计算 | 建立SAR坐标系；计算中心、速度方向、坐标轴 |
| `taywin.m` | Taylor窗函数生成 | 生成用于SAR处理的Taylor窗 |

### 📂 `data/` - 数据目录

| 文件 | 作用 |
|---|---|
| `datai_f.dat / datar_f.dat` | 数据文件（具体用途需结合代码判断） |

### 📂 `target/` - 目标模型目录

| 文件 | 作用 |
|---|---|
| `TG1.obj` | 光学仿真用3D模型（Wavefront OBJ） |
| `TG1.obj.mat` | OBJ转换后的三角面片数据（预计算） |
| `TG1_sat_point.mat` | ISAR点云数据 |
| `TG1_sat_face.mat` | ISAR面片索引数据 |

### 📂 `TLE/` - 轨道数据目录

| 文件 | 作用 | 内容/说明 |
|---|---|---|
| `TLE.txt` | 两行元素格式轨道数据 | 卫星NORAD ID: 37820；观测站位置（纬度46.648°，经度130.307°） |
| `RAE.mat` | 处理后的轨道数据（MATLAB格式） | 距离(R)、方位角(A)、俯仰角(E)、时间(T)、LLH坐标等 |

### 📂 `img_tg/` - 输出图像目录

| 目录 | 作用 | 文件 |
|---|---|---|
| `op_0.3/` | 保存生成的光学图像 | `.bmp`：128×128灰度图像；`b2.txt`：关键点标注（图像路径、类别、坐标） |

---

## 🔄 代码执行流程总结

    main_TG.m
    ├─ GeoCal.m (加载轨道数据)
    ├─ sphere_homeo.m (初始化采样)
    ├─ param_target.m (加载3D模型)
    └─ 主循环 (num = 360:100:8100)
         ├─ 计算旋转姿态 (四元数)
         └─ 对每个观测时刻
              ├─ 旋转目标模型
              ├─ LOSCalculation_motion.m (计算LOS)
              ├─ CameraandRay.m (计算相机参数)
              ├─ image_generate.m (生成图像)
              └─ 保存图像和标注

---

## 🎯 核心算法

| 算法点 | 对应模块/函数 | 说明 |
|---|---|---|
| 射线追踪（加速求交） | `buildtree2.mexw64`、`cal_insec.*`、`image_generate.m` | 对三角面片进行射线求交，支撑像素级成像 |
| 散射模型（一次/二次） | `image_generate.m` | Lambert 模型，一次/二次散射能量计算 |
| 坐标系变换链 | `GeoCal.m`、`LOSCalculation_motion.m`、`CameraandRay.m` | ECEF → 目标本体（RVN）→ 相机坐标系 |
| 四元数姿态旋转 | `main_TG.m`（姿态计算/旋转逻辑） | 用于姿态空间遍历与目标姿态变换 |

---

## main_TG.m 输入、操作与输出

### 一、输入数据（Inputs）

#### 1) 轨道数据（GeoCal.m）

| 项目 | 内容 |
|---|---|
| 来源 | `TLE/RAE.mat` |
| 变量 | `R`：距离数组；`A`：方位角数组；`E`：俯仰角数组；`T`：时间数组；`LLH`：经纬度高度 |
| 处理结果 | `r_targetECEF`（目标ECEF坐标）；`r_gdECEF`（观测站ECEF坐标） |
| 观测时刻索引 | `Obindexc = [1600 1800 2000 3500 3800 3900]` |

#### 2) 目标模型（param_target.m）

| 模块 | 输入文件 | 输出/变量 |
|---|---|---|
| ISAR | `target/TG1_sat_point.mat` | `mVerticesMatrix` |
| ISAR | `target/TG1_sat_face.mat` | `mFacesMatrix` |
| 光学 | `target/TG1.obj` | `filename` |
| 光学 | `target/TG1.obj.mat` | `trifacets` |
| 关键点 | `Keypoints = [-1602 -6259 1022; ...; ...]`（6个3D关键点） | 关键点集合 |

| 处理后变量 | 含义 |
|---|---|
| `Cor_point0` | 目标点云（旋转后） |
| `NxN` | 点数 |
| `NxN1` | 关键点数（=6） |

#### 3) 成像参数

| 参数项 | 取值/说明 |
|---|---|
| 分辨率 | `Op_detR = 0.3`，`Op_detA = 0.3` |
| 图像尺寸 | `K = 128`，`N = 128` |
| 距离 | `Rs = 1000` |
| 波长相关 | `DDtheta = lambda/2/DeltaA`，`prf = 10` |

#### 4) 旋转参数

| 参数项 | 取值/说明 |
|---|---|
| 姿态空间 | `N_axis = 90`，`N_angle = 90`（共8100种姿态） |
| 自旋轴 | `rotR = [1 0 0]'` |
| 自旋角速度 | `OmegaR = 0.015 rad/s` |
| 二次项 | `OmegaRv = 0` |

---

### 二、主要操作流程（Processing）

#### 阶段1：初始化（第1–13行）

| 步骤 | 调用/语句 | 作用 |
|---|---|---|
| 1 | `GeoCal;` | 加载轨道数据，计算 `r_targetECEF`, `r_gdECEF` |
| 2 | `sphere_homeo;` | 初始化球面采样（虽未直接使用） |
| 3 | `param_target;` | 加载3D模型，设置成像参数 |

#### 阶段2：主循环（第27–164行）

| 循环 | 范围/次数 | 说明 |
|---|---|---|
| 姿态循环 | `num = 360:100:8100`（共79个） | 遍历姿态样本（由姿态空间映射得到） |
| 观测时刻循环 | `num_seq = 1:6` | 对应 `Obindexc` 的6个观测时刻 |

#### 阶段2（补充）：姿态计算（第29–43行）

| 计算项 | 说明 |
|---|---|
| 索引映射 | `num` 映射到 `index`（0–7739） |
| 轴/角索引 | `i_axis`（1–90），`j_angle`（0–89） |
| 姿态表示 | 由 `i_axis`、`j_angle` 生成四元数 `q` |

#### 阶段2（补充）：单个观测时刻处理链（第49–132行）

| 处理环节 | 对应模块/函数 | 结果/产物 |
|---|---|---|
| 目标姿态与自旋变换 | `main_TG.m`、`rot.m` | 得到当前时刻的目标姿态点云/关键点 |
| LOS/图像轴计算 | `LOSCalculation_motion.m` | `ray_vec_Camera`、`vertice_axis`、`horizon_axis` |
| 相机参数矩阵生成 | `CameraandRay.m` | `Mat_CameraPosition`、`Mat_rayvec_Camera`（128×128） |
| 图像生成（射线追踪+散射+后处理） | `image_generate.m`（内部调用 `buildtree2`） | `Cameraimage`（生成图像） |
| 图像幅度与归一化 | `main_TG.m` | `abs` 幅度图 + `mat2gray` 归一化 |

---

### 三、输出内容（Outputs）

#### 1) 图像文件

| 项目 | 内容 |
|---|---|
| 输出路径 | `img_tg\op_0.3\{num}-{num_seq}.bmp` |
| 格式 | 128×128 灰度 BMP |
| 示例 | `360-1.bmp, 360-2.bmp, ..., 8100-6.bmp` |
| 数量 | 约 `79 × 6 ≈ 474` 张 |

#### 2) 关键点标注文件

| 项目 | 内容 |
|---|---|
| 输出路径 | `img_tg\op_0.3\b2.txt` |
| 每行格式 | `图像路径 Class 1 x1 y1 x2 y2 ... x6 y6` |
| 示例 | `img_tg\op_0.3\360-1.bmp Class 1 64.5 65.2 32.1 98.7 ... 95.3 45.1` |
| 坐标计算 | `x = Op.KeyPointHOR(i) / Op_detR + K/2`；`y = Op.KeyPointVer(i) / Op_detR + K/2` |

#### 3) 可视化输出

| figure | 内容 |
|---|---|
| `figure(1)` | 轨道与观测站位置（ECEF坐标系，左图）；目标本体坐标系中观测站位置（RVN坐标系，右图） |
| `figure(101)` | 生成的光学图像叠加关键点（红线点） |

---

### 四、位姿关系说明（Pose）

| 项目 | 内容 |
|---|---|
| 姿态表示 | 四元数 `q`（由 `i_axis` 和 `j_angle` 计算） |
| 观测几何 | `ray_vec_Camera`（视线方向）；`vertice_axis`、`horizon_axis`（图像轴） |
| 关键点投影 | 将 3D 关键点投影到 2D 图像坐标 |
| 隐含位姿 | 通过姿态编号 `num`、观测时刻 `index_c`、以及几何参数可重构目标在 ECEF 中的位姿 |

---

### 总结

| 类别 | 内容 |
|---|---|
| 输入 | 轨道数据（RAE）、3D模型、成像参数、姿态空间定义 |
| 操作 | 姿态计算、旋转变换、坐标系转换、LOS计算、射线追踪、图像生成与后处理 |
| 输出 | 光学图像（BMP）与关键点标注文件（b2.txt） |
| 用途 | 生成带位姿标注的光学图像数据集，可用于训练姿态估计模型 |
