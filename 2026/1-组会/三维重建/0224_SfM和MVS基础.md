# SfM 与 MVS 学习汇报

本文整理 SfM（Structure-from-Motion）与 MVS（Multi-View Stereo）的核心理论链条、关键假设与典型退化情形，用于学习汇报与后续方法对比。

---

## 速览

- **SfM 解决什么**：从多张图像中恢复相机位姿 $`R_i,t_i`$，以及场景的稀疏三维结构 $`\{X_j\}`$。核心约束来自多视几何，最终通过 BA 最小化全局重投影误差来获得一致的相机与结构。
- **MVS 解决什么**：在相机位姿已知或足够准确的前提下估计稠密几何，常见输出是深度图、稠密点云或网格。核心约束来自光度一致性与多视几何一致性验证。弱纹理、反光透明、遮挡以及位姿误差都会显著影响稠密结果并产生孔洞。
- **两者关系**：经典流程通常先做 SfM 得到位姿与稀疏结构，再做 MVS 得到稠密几何。

---

## 目录

- [🧭 整体流程](#-整体流程)
- [🧱 SfM 理论主线](#-sfm-理论主线)
- [🧩 MVS 理论主线](#-mvs-理论主线)

---

## 🧭 整体流程

### 1 SfM 流程

1.1 提取并匹配特征点，得到跨视图对应关系。  
1.2 利用鲁棒估计拟合两视几何，得到 $`F`$ 或 $`E`$。  
1.3 选择视差较好的初始视图对，初始化相对位姿并三角化得到第一批稀疏三维点。  
1.4 逐步加入新视图，通过 PnP 在已有三维点上估计新相机位姿，并继续三角化扩张地图。  
1.5 通过局部与全局 BA 最小化重投影误差，抑制误差累积并提升全局一致性。  

### 2 MVS 流程

2.1 以深度为未知量，基于相机位姿进行几何对齐。  
2.2 通过光度一致性定义代价，并在多视图上进行聚合。  
2.3 采用高效搜索策略估计深度，常结合局部平面等先验。  
2.4 进行一致性验证与过滤，剔除不可靠深度并控制噪声。  
2.5 融合多视图有效深度，输出稠密点云或网格，并分析孔洞等误差来源。  


## 🧱 SfM 理论主线

本节按“整体流程”中的 1.1–1.5 逐步展开 SfM 的理论要点，便于与流程对照阅读。

### 1.1 特征与匹配

SfM 的直接观测来自跨视图的对应关系，即同一物理点在不同图像上的像素位置。对应关系通常通过局部特征提取与匹配获得，但天然会包含外点。外点如果不被抑制，会直接影响后续两视几何估计与位姿恢复，因此鲁棒机制贯穿整个流程。

### 1.2 两视极几何估计（F/E）与鲁棒拟合
<img width="435" height="192" alt="image" src="https://github.com/user-attachments/assets/1af5a29e-b825-4d79-b0e9-f2743d6e30e8" />

极几何刻画两张图像之间的对应限制。给定图像 1 的点，图像 2 的对应点不可能出现在任意位置，而必须落在一条极线上。该关系在像素齐次坐标下由基本矩阵 $`F`$ 表示：

$$
\tilde{x}'^{T} F \tilde{x} = 0
$$

由于匹配中存在外点，通常需要用 RANSAC 这类鲁棒估计方法：反复抽样拟合 $`F`$，再用几何误差评价一致性，选择一致内点最多的模型，从而得到可靠的两视几何估计。

当相机内参已知时，可以将 $`F`$ 转换为本质矩阵 $`E`$：

$$
E = K'^{T} F K
$$

在归一化相机坐标中，约束写为：

$$
\hat{x}'^{T} E \hat{x} = 0
$$

本质矩阵与相机相对运动相关，常写为：

$$
E = [t]_{\times} R
$$

其中 $`R`$ 为相对旋转，$`t`$ 为相对平移方向。单目情形下平移尺度不可观，因此 $`t`$ 仅能在方向意义上恢复。

### 1.3 初始化与三角化（第一批稀疏三维点）

在两视几何确定后，可以恢复两相机的相对位姿并进行三角化得到第一批三维点。由于对 $`E`$ 的分解会产生多组候选 $`(R,t)`$，通常通过正深度条件选择正确解：对每个候选解三角化若干点，只有正确解会使大多数点位于两台相机前方。

三角化的稳定性由视差决定。视差过小会导致深度对像素噪声极其敏感，因此初始化通常需要选择视差足够的视图对，并在生成三维点后根据正深度与重投影误差过滤不可靠点。

### 1.4 增量注册（PnP）与地图扩张

当已有一批三维点，并且在新图像中找到这些三维点的二维观测后，就形成 3D 与 2D 对应。PnP 通过最小化重投影误差估计新相机位姿，并把新相机直接注册到当前地图坐标系中。由于 3D 与 2D 对应同样可能包含外点，PnP 通常与 RANSAC 结合提高鲁棒性。

注册新相机后继续三角化新点能够扩张地图覆盖范围，增加可用于后续注册的三维锚点，从而形成稳定的增量扩张过程。

### 1.5 BA 全局一致性优化

SfM 的各步骤均含噪，误差会在增量过程中累积。BA 将所有相机位姿与三维点作为变量，最小化全部观测的重投影误差，从而提升全局一致性并抑制漂移：

$$
\min_{\{R_i,t_i\},\{X_j\}} \sum_{(i,j)} \rho\big(\|\pi(P_i X_j) - x_{ij}\|^2\big)
$$

其中 $`\rho`$ 为鲁棒核，用于降低外点对优化的影响。实际流程中常交替进行相机注册、三角化与局部 BA，并在关键阶段执行全局 BA，以进一步消除长期累积误差。

### 关键假设与典型退化

SfM 通常假设场景近似静态刚体，跨视图存在稳定可匹配特征，并且视图之间具有足够重叠与视差。典型退化包括小视差或近纯旋转导致深度不可观，重复纹理导致误匹配，内参不准导致系统性误差，外点比例过高导致鲁棒估计不稳定。

## 🧩 MVS 理论主线

本节按“整体流程”中的 2.1–2.5 逐步展开 MVS 的理论要点。MVS 以像素级深度为目标，核心思想是在相机位姿已知或足够准确的前提下，用多视图的外观一致性与几何一致性约束来估计与筛选深度。

### 2.1 深度未知量与几何对齐

在参考视图中，一个像素对应一条射线。对像素 $`\tilde{p}`$ 的深度记为 $`d`$，该像素对应的三维点可写为：

$$
X_r(d) = d\,K_r^{-1}\tilde{p}
$$

给定深度假设后，可以把该三维点投影到其他视图，得到其在视图 $`k`$ 中的位置：

$$
p_k(d) = \pi\big(K_k\,(R_k X(d) + t_k)\big)
$$

其中 $`\pi(\cdot)`$ 表示透视投影。上述关系说明 MVS 的核心步骤依赖相机位姿，位姿误差会直接导致几何对齐偏移，从而破坏后续的一致性计算。

### 2.2 光度一致性代价与多视图聚合

对参考视图的像素或局部 patch，若深度假设正确，则将其投影到其他视图后应对应同一物理表面点，外观应保持相对一致。由此定义光度一致性代价：

$$
C_k(p,d) = \mathrm{Cost}\big(\mathrm{patch}(I_r,p),\ \mathrm{patch}(I_k,p_k(d))\big)
$$

多视图情况下，对若干邻视图进行聚合得到：

$$
C(p,d) = \mathrm{Agg}_{k\in \mathcal{N}(r)} C_k(p,d),\qquad
d^*(p) = \arg\min_d C(p,d)
$$

该框架隐含外观可比性假设。弱纹理会降低代价的区分度，反光透明与强光照变化会破坏外观一致性，遮挡会使部分视图的观测不再来自同一物理点，因此实际系统常采用更鲁棒的聚合策略以降低异常视图的影响。

### 2.3 高效搜索与局部平面先验

由于深度是连续变量，若对每个像素穷举所有候选深度会带来很高计算量，因此需要高效搜索或近似优化。常见做法是对深度离散化形成代价体，并利用局部先验加速求解。

PatchMatch 类方法利用自然场景深度在空间上局部连续、表面可近似为分段平面的特性，通过邻域传播与随机搜索让较优的深度或平面假设在局部扩散并逐步改进，从而避免全局穷举。

### 2.4 一致性验证与过滤

深度估计阶段往往会产生噪声与错误深度。为了控制稠密几何的可信度，MVS 通常引入一致性验证并进行过滤。过滤主要包含两类思想：一是光度一致性层面的筛选，二是多视几何一致性层面的验证。

几何一致性可以理解为跨视图的投影一致检验。例如参考视图估计的三维点投影到邻视图后，在邻视图的深度估计中应能得到相容的深度支持；若不相容，则该像素的深度假设不可信并被剔除。该策略通常宁缺毋滥，会带来孔洞，但能显著减少飞点与伪结构。

### 2.5 融合输出与孔洞根因

通过一致性验证后，将多个视图的有效深度点融合到统一坐标系中，得到稠密点云；在此基础上可进一步生成网格。融合阶段通常包含去重与滤噪，以提升几何稳定性。

孔洞一般来自两类原因。第一类是观测条件破坏了光度一致性，例如弱纹理、反光透明、强光照变化与遮挡。第二类是位姿误差导致几何投影系统性偏移，使正确深度也无法获得足够的一致性支持，最终在过滤中被大量剔除。因此，MVS 的有效性高度依赖位姿精度与外观可比性条件。
