# 实现小样本中的去云大样本模型算法应用

## 准备小样本数据集

目标是收集并准备一个具有代表性的小样本数据集，以便用于迁移学习实验。

### 需求分析

RGB（光学）图像预处理
- 读取图像：使用`get_opt_image`函数读取RGB图像。该函数打开给定路径的TIFF文件，并读取前3个通道（假设是RGB通道）的数据。
- 填充缺失值：用非NaN像素的平均值替换NaN像素值，以填补图像中的空洞和伪影。
- 数据类型转换：将图像数据转换为float32类型。
- 归一化：在`get_normalized_data`函数中，根据预设的最小和最大值（针对RGB图像，这些值为0和10000）进行归一化处理，然后通过除以一个比例因子（这里是10000）将数据缩放到[0,1]范围内。

SAR图像预处理
- 读取图像：使用`get_sar_image`函数读取SAR图像，该函数以类似于读取RGB图像的方式打开并读取图像数据。
- 填充缺失值：同样，用非NaN像素的平均值替换NaN像素值。
- 数据类型转换：将图像数据转换为float32类型。
- 归一化：在`get_normalized_data`函数中，对SAR图像的每个通道进行归一化，使用预设的最小和最大值（VV通道为-25到0，VH通道为-32.5到0）进行裁剪，然后缩放到[0,1]范围内。

其他处理步骤
- 图像尺寸调整：在`SEN12MSDataset`类中的`transform`方法中，使用`torch.nn.AdaptiveAvgPool2d`将图像尺寸调整为128x128，以统一数据集中图像的大小。
- 数据组织：`__getitem__`方法通过索引读取SAR图像及其对应的无云和有云RGB图像，对它们进行预处理和归一化，然后调整尺寸，最后返回处理后的数据。
- 数据加载：`SEN12MSDataset`类实现了`__len__`方法，返回数据集中图像的总数，使其能够与PyTorch的数据加载器（如`DataLoader`）一起使用，方便批量处理和迭代训练。

### 数据收集

- **SEN12MS-CR**: 从原始数据集中选取了不同季节的图像。尽管RGB图像原本包含13个通道，但为了便于可视化，裁剪为3个通道，虽然这样做效果仍不理想。与之相比，SAR图像相对较为清晰。  
![image](https://github.com/ZYJ-Group/Tanghy/assets/94824386/86111a2a-f90c-4356-9b18-9a74364675e6)  
![image](https://github.com/ZYJ-Group/Tanghy/assets/94824386/74192c09-c10a-414e-afa7-94bd85d0368a)  

- **rice**: 该数据集仅包含带云的RGB图像、云掩膜以及无云的地面真实（GT）图像，并不包含SAR图像，因此不适合作为小样本数据集。
![image](https://github.com/ZYJ-Group/Tanghy/assets/94824386/34aa66f8-fece-4ae9-bb64-a01c10d0af8e)  


- **GEE**: 通过Google Earth Engine（GEE）自主采集图像时遇到一些问题：有效图像的获取需要大量采集，可能在100张图像中仅能获取3张符合要求的图像；确定图像质量的标准较为困难，难以界定何种图像可作为地面真实（GT）图像，以及带云RGB图像的云量标准；地点选择方面也存在疑问，比如是否应包含建筑物、是否应选择沙漠、雪地或农田等特定场景。  
![image](https://github.com/ZYJ-Group/Tanghy/assets/94824386/9bdea631-a429-4d6e-a4a5-a2b75fcc59ff)  


### 数据预处理

对大量空白或残缺图像进行清除，保留相对完整且清晰的图像，然后基于直觉挑选出相应的带云RGB图像、SAR图像以及无云的GT图像。
![image](https://github.com/ZYJ-Group/Tanghy/assets/94824386/cddfbbef-56ae-4441-a0e3-216a22843f7f)


### 进行数据增强

初步采用了模拟云覆盖与去除的方法进行数据增强。

### 初步分析

现有数据难以直接利用，自采集的数据标准难以把握，且工作量较大。
